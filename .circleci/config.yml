version: 2

jobs:
  build_and_test:
    docker:
      - image: ros:rolling
    steps:
      - checkout
      - run:
          name: Setup workspace
          command: |
            mkdir -p src/grid_map
            mv `find -maxdepth 1 -not -name . -not -name src` src/grid_map/
            vcs import src < src/grid_map/tools/ros2_dependencies.repos
            apt-get update
            apt-get upgrade
            rosdep update
            DEBIAN_FRONTEND=noninteractive rosdep install -iry --from-paths . --rosdistro $ROS_DISTRO \
              --skip-keys "slam_toolbox"
      - run:
          name: Debug Build
          command: |
            colcon build --parallel-workers 1 --packages-up-to $(colcon list --names-only --base-paths src/grid_map/)
      - run:
          name: Run Tests
          command: |
            colcon test --parallel-workers 1 --packages-select $(colcon list --names-only --base-paths src/grid_map/)
            colcon test-result --verbose
workflows:
  version: 2
  ros_build:
    jobs:
      - build_and_test
